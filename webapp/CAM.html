<!DOCTYPE html >
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <title>CNC CAM</title>
    <script src="libs/jquery.min.js"></script>
    <script src="libs/jquery.flot.min.js"></script>
    <script src="libs/jquery.flot.resize.js"></script>
    <script src="libs/Three.js"></script>
    <script src="libs/TrackballControls.js"></script>
    <script src="libs/jsparse.js"></script>
    <script src="libs/svg.js"></script>
    <script src="libs/svg.draggable.js"></script>
    <script src="libs/svg.memory.js"></script>
    <script src="libs/jquery.mousewheel.js"></script>
    <script src="libs/clipper_unminified.js"></script>
    <script src="libs/opentype.js"></script>
    <script src="libs/extractedRaphael.js"></script>
    <script src="libs/ace/src-noconflict/ace.js"></script>
    <script src="cnc/beziers.js"></script>
    <script src="cnc/cam.js"></script>
    <script src="cnc/geometry.js"></script>
    <script src="cnc/simulation.js"></script>
    <script src="cnc/parser.js"></script>
    <script src="cnc/threeDView.js"></script>
    <script src="cnc/twoDView.js"></script>
    <style>
        html, body {
            height: 100%;
        }

        body {
            background-color: white;
            display: flex;
            margin: 0;
        }

        .editBlock {
            display: flex;
            flex-direction: column;
            flex: 1;
        }

        .editBlock pre {
            flex: 1;
        }

        .editBlock button {
            align-self: flex-end;
        }

        #views {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        #container {
            background: #2F2F2F;
            flex: 1;
        }

        #drawing {
            flex: 1;
            overflow: hidden;
        }

        #codebox {
            margin: 0;
        }
    </style>
</head>
<body>
<div class="editBlock">
    <pre id="codebox">
        opentype.load('libs/fonts/miss_fajardose/MissFajardose-Regular.ttf', function (err, font) {
            var path = font.getPath('Test');
            var res = '';
            for (var i = 0; i < path.commands.length; i++) {
                var command = path.commands[i];
                res += ' ' + command.type;
                if (command.type == 'M' || command.type == 'L')
                    res += ' ' + command.x + ',' + -command.y;
                else if (command.type == 'Q')
                    res += command.x1 + ',' + -command.y1 + ' ' + command.x + ',' + -command.y;
                else if (command.type == 'C')
                    res += command.x1 + ',' + -command.y1 + ' ' + command.x2 + ',' + -command.y2
                        + ' ' + command.x + ',' + -command.y;
            }
            var poly = machine.toClipper(machine.createOutline(res));
            poly = machine.polyOp(poly, [], ClipperLib.ClipType.ctUnion);
            machine.setParams(-19, 10, 1000);
            machine.registerToolPathArray(machine.fromClipper(machine.contourClipper(poly, 0.5, false)));
            whenDone();
        });
    </pre>
    <button id="simulationButton">Simulate</button>
</div>
<div id="views">
    <div id="container"></div>
    <div id="drawing"></div>
</div>
<script>
    var editor = ace.edit("codebox");
    editor.setTheme("ace/theme/twilight");
    editor.session.setMode("ace/mode/javascript");
    var threeDView = new ThreeDView($('#container'));
</script>
<script>
    window.addEventListener("message", function (event) {
        if (event.data['type'] == 'gimme program') {
            //event.source.postMessage({type: 'program', program: $('#codebox').val()}, event.origin);
        }
        if (event.data['type'] == 'toolPosition') {
            var pos = event.data['position'];
            threeDView.tool.position.setX(pos.x);
            threeDView.tool.position.setY(pos.y);
            threeDView.tool.position.setZ(pos.z);
            threeDView.tool.traverse(function (child) {
                child.visible = true;
            });
            threeDView.renderer.render(threeDView.scene, threeDView.camera);
        }
    }, false);
</script>
<script>
    var twoDView = new TwoDView($('#drawing'));
    var codebox = $('#codebox');
    var code = localStorage.getItem('code');
    if (code)
        editor.setValue(code);
    editor.getSession().on('change', function () {
        localStorage.setItem('code', editor.getValue());
    });
    var button = $('#simulationButton');
    var machine = null;
    function whenDone() {
        twoDView.zoomExtent();
        threeDView.displayPath(machine.dumpPath());
        var lastT = null;
        simulate2(machine.simulablePath(), function (x, y, z, t) {
            lastT = t;
        });
        console.log('total duration', lastT);
    }
    function refresh() {
        machine = new Machine(twoDView.paper);
        twoDView.clear();
        eval(editor.getValue());
        whenDone();
    }
    button.click(function () {
        refresh();
    });
    refresh();
</script>
</body>
</html>

