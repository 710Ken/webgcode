<!DOCTYPE html >
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <title>CNC CAM</title>
    <script src="libs/jquery.min.js"></script>
    <script src="libs/jquery.flot.min.js"></script>
    <script src="libs/jquery.flot.resize.js"></script>
    <script src="libs/Three.js"></script>
    <script src="libs/TrackballControls.js"></script>
    <script src="libs/jsparse.js"></script>
    <script src="libs/svg.js"></script>
    <script src="libs/svg.draggable.js"></script>
    <script src="libs/svg.memory.js"></script>
    <script src="libs/jquery.mousewheel.js"></script>
    <script src="libs/clipper_unminified.js"></script>
    <script src="cnc/cam.js"></script>
    <script src="cnc/geometry.js"></script>
    <script src="cnc/simulation.js"></script>
    <script src="cnc/parser.js"></script>
    <script src="cnc/threeDView.js"></script>
    <style>
        html, body {
            height: 100%;
        }

        body {
            background-color: white;
            display: flex;
            margin: 0;
        }

        .editBlock {
            display: flex;
            flex-direction: column;
            text-align: right;
            flex: 1;
        }

        .editBlock textarea {
            flex: 1;
        }

        .editBlock button {
            align-self: flex-end;
        }

        #views {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        #container {
            background: #2F2F2F;
            flex: 1;
        }

        #drawing {
            flex: 1;
            overflow: hidden;
        }
    </style>
</head>
<body>
<div class="editBlock">
    <textarea id="codebox" placeholder="Paste your javascript here...">
        var toolDiameter = 3;
        var toolRadius = toolDiameter / 2;

        var plugHole = machine.createOutline('M40,25' + createRelativeRectangle(-15.5, 15.5));
        var cornerHoles = machine.drillCorners(plugHole);
        machine.registerToolPathArray(cornerHoles);


        var plugHoleToolPath = machine.contouring(plugHole, toolRadius, true, true);
        machine.registerToolPathArray(plugHoleToolPath);

        var spindleRadius = 65.5 / 2;
        var circle = machine.createOutline(createCircle(47 + spindleRadius, 40, spindleRadius));
        var circleToolPath = machine.contouring(circle, toolRadius, true, true);
        machine.registerToolPathArray(circleToolPath);

        var rectangle = machine.createOutline('M0,0' + createRelativeRectangle(120, 80));
        var rectangleToolPath = machine.contouring(rectangle, toolRadius, false, true);
        machine.registerToolPathArray(rectangleToolPath);

        var travelZ = 10;
        var workZ = -5;

        machine.setParams(workZ, travelZ, 500);
    </textarea>
    <button id="simulationButton">Simulate</button>
</div>
<div id="views">
    <div id="container"></div>
    <div id="drawing"></div>
</div>
<script>
    var $container = $('#container');
    var threeDView = new ThreeDView($container);
</script>
<script>
    window.addEventListener("message", function (event) {
        if (event.data['type'] == 'gimme program') {
            evaluateCode();
            event.source.postMessage({type: 'program', program: $('#codebox').val()}, event.origin);
        }
        if (event.data['type'] == 'toolPosition') {
            var pos = event.data['position'];
            var toolPos = $('#toolPos');
            toolPos.attr('translation', [pos.x, pos.y, pos.z].join(' '));
            toolPos.attr('render', true);
            tool.position.setX(pos.x);
            tool.position.setY(pos.y);
            tool.position.setZ(pos.z);
            tool.traverse(function (child) {
                child.visible = true;
            });
            renderer.render(scene, camera);
        }
    }, false);
    //evaluateCode();
</script>
<script>
    var drawing = $('#drawing');
    var svg = SVG(drawing[0]).size(drawing.width(), drawing.height());
    var paper = svg.group().attr({id: 'root', 'vector-effect': 'non-scaling-stroke'});
    function setMatrix(element, matrix) {
        var components = $.map('abcdef'.split(''),function (c) {
            return matrix[c];
        }).join(',');
        element.attr({transform: 'matrix(' + components + ')'});
    }
    drawing.mousewheel(function (event, delta) {
        if (typeof event.offsetX === "undefined" || typeof event.offsetY === "undefined") {
            var targetOffset = $(event.target).offset();
            event.offsetX = event.pageX - targetOffset.left;
            event.offsetY = event.pageY - targetOffset.top;
        }
        var svgRoot = paper.node;
        var p = svg.node.createSVGPoint();
        p.x = event.offsetX;
        p.y = event.offsetY;
        p = p.matrixTransform(svgRoot.getCTM().inverse());
        var k = svg.node.createSVGMatrix().translate(p.x, p.y).scale(1 + delta / 360).translate(-p.x, -p.y);
        var m = svgRoot.getCTM().multiply(k);
        setMatrix(paper, m);
        event.preventDefault();
    });
    function zoomExtent(paper) {
        var box = paper.bbox();
        var m = paper.node.getCTM();
        var newScale = Math.min(svg.node.width.baseVal.value / box.width, svg.node.height.baseVal.value / box.height) * 0.9;
        m.a = newScale;
        m.d = -newScale;
        m.e = -box.x + box.width * 0.25;
        m.f = -(-box.y + box.height * 0.5 - svg.node.height.baseVal.value);
        setMatrix(paper, m);
    }
    $(window).resize(function resizeSVG() {
        svg.size(drawing.width(), drawing.height());
    });
    var button = $('#simulationButton');
    var machine = null;
    function refresh() {
        machine = new Machine(paper);
        paper.clear();
        eval($('#codebox').val());
        zoomExtent(paper);
        threeDView.displayPath(machine.dumpPath());
    }
    button.click(function () {
        refresh();
    });
    refresh();
</script>
</body>
</html>

