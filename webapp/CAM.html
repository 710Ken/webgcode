<!DOCTYPE html >
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <title>CNC CAM</title>
    <script src="libs/jquery.min.js"></script>
    <script src="libs/jquery.flot.min.js"></script>
    <script src="libs/jquery.flot.resize.js"></script>
    <script src="libs/Three.js"></script>
    <script src="libs/TrackballControls.js"></script>
    <script src="libs/jsparse.js"></script>
    <script src="libs/svg.js"></script>
    <script src="libs/svg.draggable.js"></script>
    <script src="libs/svg.memory.js"></script>
    <script src="libs/jquery.mousewheel.js"></script>
    <script src="libs/clipper_unminified.js"></script>
    <script src="libs/opentype.js"></script>
    <script src="libs/extractedRaphael.js"></script>
    <script src="libs/ace/src-noconflict/ace.js"></script>
    <script src="cnc/util.js"></script>
    <script src="cnc/beziers.js"></script>
    <script src="cnc/cam.js"></script>
    <script src="cnc/geometry.js"></script>
    <script src="cnc/simulation.js"></script>
    <script src="cnc/parser.js"></script>
    <script src="cnc/threeDView.js"></script>
    <script src="cnc/twoDView.js"></script>
    <style>
        html, body {
            height: 100%;
        }

        body {
            background-color: white;
            display: flex;
            margin: 0;
        }

        .editBlock {
            display: flex;
            flex-direction: column;
            flex: 1;
        }

        .editBlock pre {
            flex: 1;
        }

        .editBlock button {
            align-self: flex-end;
        }

        #views {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        #container {
            background: #2F2F2F;
            flex: 1;
        }

        #drawing {
            flex: 1;
            overflow: hidden;
        }

        #codebox {
            margin: 0;
        }
    </style>
</head>
<body>
<div class="editBlock">
    <pre id="codebox">
    var outerWidth = 100;
    var angle = 100;
    var angleRadian = angle * Math.PI / 180;
    var backsideMinWidth = 4;
    var outerHeight = 25;
    var virtualMeetingPointY = -1;
    var ratio = Math.tan(angleRadian / 2);
    var slopeDX = (outerHeight - backsideMinWidth) * ratio;
    var topDx = outerWidth / 2 - (outerHeight - virtualMeetingPointY) * ratio;
    var plankThickness = 18;

    function createBracket(machine) {
        var toolRadius = 3 / 2;
        var shape = geom.op('M', 0, 0) + geom.op('l', outerWidth, 0) + geom.op('l', 0, outerHeight)
            + geom.op('l', -topDx, 0)
            + geom.op('l', -slopeDX, -(outerHeight - backsideMinWidth))
            + geom.op('l', -(outerWidth - topDx * 2 - slopeDX * 2), 0)
            + geom.op('l', -slopeDX, outerHeight - backsideMinWidth)
            + geom.op('l', -topDx, 0) + 'Z';
        var outline = machine.createOutline(shape);
        machine.setParams(-17, 10, 1000);
        machine.registerToolPathArray(machine.rampToolPathArray(machine.contouring(outline, toolRadius, false, true), -0, -plankThickness, 3));
    }
    createBracket(machine);
    </pre>
    <button id="simulationButton">Simulate</button>
</div>
<div id="views">
    <div id="container"></div>
    <div id="drawing"></div>
</div>
<script>
    var inChromeApp = window.location.hash == '#fromApp';
    var editor = ace.edit("codebox");
    editor.setTheme("ace/theme/twilight");
    if (inChromeApp) //https://code.google.com/p/chromium/issues/detail?id=159303
        editor.session.setUseWorker(false);
    editor.session.setMode("ace/mode/javascript");
    var threeDView = new ThreeDView($('#container'));
</script>
<script>
    window.addEventListener("message", function (event) {
        if (event.data['type'] == 'gimme program') {
            var port = event.ports[0];
            refresh(function (machine) {
                refreshViews(machine);
                var parameters = event.data.parameters;
                port.postMessage({type: 'toolpath', toolPath: machine.getToolPath(parameters), parameters: parameters});
            });
        }
        if (event.data['type'] == 'toolPosition') {
            var pos = event.data['position'];
            threeDView.tool.position.setX(pos.x);
            threeDView.tool.position.setY(pos.y);
            threeDView.tool.position.setZ(pos.z);
            threeDView.tool.traverse(function (child) {
                child.visible = true;
            });
            threeDView.renderer.render(threeDView.scene, threeDView.camera);
        }
    }, false);
</script>
<script>
    var twoDView = new TwoDView($('#drawing'));
    if (!inChromeApp) {
        var code = localStorage.getItem('JSCode');
        if (code)
            editor.setValue(code);
        editor.getSession().on('change', function () {
            localStorage.setItem('JSCode', editor.getValue());
        });
    }
    function refreshViews(machine) {
        twoDView.zoomExtent();
        threeDView.displayPath(machine.dumpPath());
    }
    function refresh(callback) {
        var machine = new Machine(twoDView.paper);
        var whenDone = callback || function () {
        };
        twoDView.clear();
        var resWasFalse;
        var res = new Function(['machine', 'whenDone'], editor.getValue())(machine, function () {
            if (resWasFalse)
                throw new Error('you called whenDone() also you didn\'t return true in your code.');
            whenDone(machine);
        });
        if (!res) {
            resWasFalse = true;
            whenDone(machine);
        }
    }
    $('#simulationButton').click(function () {
        refresh(refreshViews);
    });
    refresh(refreshViews);
</script>
</body>
</html>

