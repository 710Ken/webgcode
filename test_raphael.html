<!doctype html>
<html>
<head>
    <title>Raphael Play</title>
    <script src="webapp/libs/raphael-min.js"></script>
    <script src="webapp/libs/jquery.min.js"></script>
    <script src="webapp/libs/handlebars-1.0.0-rc.4.js"></script>
    <script src="webapp/libs/ember-1.0.0-rc.5.js"></script>
    <script src="webapp/libs/ember-data-0.13.min.js"></script>
    <script src="webapp/libs/ember-history.js"></script>
    <script src="webapp/cnc/elliptic.js"></script>
    <style>th {
        text-align: right;
    }</style>
</head>
<body>

<script type="text/x-handlebars" data-template-name="slot">
    <h2>Slot</h2>
    <table>
        <tr>
            <th><label for="length">length: </label></th>
            <td>{{view TestApp.NumberField id="length" placeholder="length"
                numericValueBinding="length"}}
            </td>
        <tr>
            <th><label for="width">width: </label></th>
            <td>{{view TestApp.NumberField id="width" placeholder="width"
                numericValueBinding="width"}}
            </td>
        </tr>
        <tr>
            <th><label for="depth">depth: </label></th>
            <td>{{view TestApp.NumberField id="depth" placeholder="depth"
                numericValueBinding="depth"}}
            </td>
        </tr>
        <tr>
            <th><label for="volume">volume (mm<sup>3</sup>): </label></th>
            <td>{{volume}}
            </td>
        </tr>
    </table>
</script>
<script type="text/x-handlebars" data-template-name="tool">
    <h2>Tool</h2>
    <table>
        <tr>
            <th><label for="diameter">diameter: </label></th>
            <td>{{view TestApp.NumberField id="diameter" placeholder="diameter"
                numericValueBinding="diameter"}}
            </td>
        </tr>
        <tr>
            <th><label for="flutes">flutes: </label></th>
            <td>{{view TestApp.NumberField id="flutes" placeholder="flutes"
                numericValueBinding="flutes"}}
            </td>
        </tr>
    </table>
</script>
<script type="text/x-handlebars" data-template-name="operation">
    <h2>Operation</h2>
    <table>
        <tr>
            <th><label for="increment">increment(a<sub>e</sub>): </label></th>
            <td>{{view TestApp.NumberField id="increment" placeholder="increment" numericValueBinding="increment"
                min="0"}}
            </td>
        </tr>
        <tr>
            <th><label for="stepOver">step over(%): </label></th>
            <td>{{view TestApp.NumberField id="stepOver"
                placeholder="step over"
                numericValueBinding="stepOver" min="0" max="100"}}
            </td>
        </tr>
        <tr>
            <th><label for="rotationFrequency">rotation frequency(rpm): </label></th>
            <td>{{view TestApp.NumberField id="rotationFrequency"
                placeholder="step over"
                numericValueBinding="rotationFrequency" min="0"}}
            </td>
        </tr>
        <tr>
            <th><label for="feedRate">feed rate(mm/min): </label></th>
            <td>{{view TestApp.NumberField id="feedRate"
                numericValueBinding="feedRate" min="0"}}

            </td>
        </tr>
        <tr>
            <th>chip load(mm):</th>
            <td>{{chipLoad}}</td>
        </tr>
        <tr>
            <th>h<sub>max</sub>:</th>
            <td>{{hMax}}</td>
        </tr>
        <tr>
            <th>surface speed(m/min):</th>
            <td>{{surfaceSpeed}}</td>
        </tr>
        <tr>
            <th>path length(mm):</th>
            <td>{{actualPathLength}}</td>
        </tr>
        <tr>
            <th>duration(hh:min:ss):</th>
            <td>{{durationText}}</td>
        </tr>
        <tr>
            <th>material removal rate (cm<sup>3</sup>/min):</th>
            <td>{{materialRemovalRate}}</td>
        </tr>
    </table>
</script>
<script type="text/x-handlebars" data-template-name="testApp">
    <h1>Trochoidal slot milling</h1>
    {{render 'tool' tool}}
    {{render 'slot' slot}}
    {{render 'operation' operation}}
    <h2>Output:</h2>

    <div style="position: relative">
        {{view TestApp.RaphaelView}}
    </div>
</script>
<script>
    function secondsToHms(d) {
        d = Number(d);
        var h = Math.floor(d / 3600);
        var m = Math.floor(d % 3600 / 60);
        var s = Math.floor(d % 3600 % 60);
        return ((h > 0 ? h + ":" : "") + (m > 0 ? (h > 0 && m < 10 ? "0" : "") + m + ":" : "0:") + (s < 10 ? "0" : "") + s);
    }
    window.TestApp = Ember.Application.create();
    TestApp.Router.map(function () {
        this.resource('testApp', { path: '/' });
    });
    TestApp.Store = DS.Store.extend({
        revision: 13,
        adapter: 'DS.FixtureAdapter'
    });
    TestApp.Document = DS.Model.extend({
        tool: DS.belongsTo('TestApp.Tool'),
        slot: DS.belongsTo('TestApp.Slot'),
        operation: DS.belongsTo('TestApp.Operation')
    });
    TestApp.Tool = DS.Model.extend({
        document: DS.belongsTo('TestApp.Document'),
        diameter: DS.attr('number'),
        flutes: DS.attr('number')
    });
    TestApp.Slot = DS.Model.extend({
        document: DS.belongsTo('TestApp.Document'),
        depth: DS.attr('number'),
        length: DS.attr('number'),
        width: DS.attr('number'),
        volume: function () {
            return this.get('depth') * this.get('length') * this.get('width');
        }.property('depth', 'length', 'width')
    });
    TestApp.Operation = DS.Model.extend({
        document: DS.belongsTo('TestApp.Document'),
        increment: DS.attr('number'),
        rotationFrequency: DS.attr('number'),
        feedRate: DS.attr('number'),
        stepOver: function (key, v) {
            var diameter = this.get('document.tool.diameter');
            var increment = this.get('increment');
            if (arguments.length === 1)
                return increment / diameter * 100;
            else
                this.set('increment', diameter * v / 100);
        }.property('increment', 'document.tool.diameter'),
        chipLoad: function () {
            return this.get('feedRate') / ( this.get('rotationFrequency') * this.get('document.tool.flutes'));
        }.property('feedRate', 'rotationFrequency', 'document.tool.flutes'),
        hMax: function () {
            var diameter = this.get('document.tool.diameter');
            var increment = this.get('increment');
            var fz = this.get('feedRate') / (this.get('document.tool.flutes') * this.get('rotationFrequency'));
            return 2 * fz * Math.sqrt(increment / diameter * (1 - increment / diameter));
        }.property('increment', 'feedRate', 'rotationFrequency', 'document.tool.diameter', 'document.tool.flutes'),
        surfaceSpeed: function () {
            return Math.PI * this.get('document.tool.diameter') * this.get('rotationFrequency') / 1000;
        }.property('rotationFrequency', 'document.tool.diameter'),
        trochoidalRadius: function () {
            var w = this.get('document.slot.width');
            var toolD = this.get('document.tool.diameter');
            return (w - toolD) / 2;
        }.property('document.slot.width', 'document.tool.diameter'),
        pathStartY: function () {
            return -this.get('document.slot.length') / 2 - this.get('trochoidalRadius');
        }.property('trochoidalRadius', 'document.slot.length'),
        pathGeneratorLength: function () {
            var l = this.get('document.slot.length') + this.get('trochoidalRadius');
            var increment = this.get('increment');
            return  (Math.ceil(l / increment) + 0.5) * increment;
        }.property('document.slot.length', 'trochoidalRadius', 'increment'),
        actualPathLength: function () {
            var trochoR = this.get('trochoidalRadius');
            var increment = this.get('increment');
            var a = increment / (2 * Math.PI);
            var m = -4 * a * trochoR / Math.pow(a - trochoR, 2);
            var t = this.get('pathGeneratorLength') / increment * 2 * Math.PI - Math.PI / 2;
            return 2 * Math.abs(a - trochoR) * incompleteEllipticIntegralSecondKind(t / 2, m);
        }.property('trochoidalRadius', 'pathGeneratorLength', 'increment'),
        duration: function () {
            return this.get('actualPathLength') / this.get('feedRate');
        }.property('actualPathLength', 'feedRate'),
        materialRemovalRate: function () {
            return this.get('document.slot.volume') / this.get('duration') / 1000;
        }.property('document.slot.volume', 'duration')
    });
    TestApp.TestAppRoute = Ember.Route.extend({
        model: function () {
            return TestApp.Document.find(1);
        }
    });
    TestApp.OperationController = Ember.ObjectController.extend({
        durationText: function () {
            console.log(this.get('duration'));
            return secondsToHms(this.get('model.duration') * 60);
        }.property('model.duration')
    });
    TestApp.NumberField = Ember.TextField.extend({
        type: 'number',
        attributeBindings: ['min', 'max', 'step'],
        numericValue: function (key, v) {
            if (arguments.length === 1) {
                var val = parseFloat(this.get('value'));
                return isNaN(val) ? null : val;
            } else
                this.set('value', v + '');
        }.property('value')
    });
    TestApp.RaphaelView = Ember.View.extend({
        didInsertElement: function () {
            this._super();
            var paper = Raphael(this.get('element'), 640, 480);
            this.set('paper', paper);
            this.set('slotDrawing', paper.rect(320, 240, 1, 1).attr({fill: '#99D9FC', 'stroke-width': 2}));
            this.set('toolDrawing', paper.circle(320, 240, null).attr({fill: '#8DAABC'}));
            this.set('operationAxis', paper.path('M320,240').attr({'stroke-dasharray': '--.', "stroke-width": 1}));
            this.set('operationPath', paper.path('M320,240').attr({stroke: 'grey'}));
        },
        changeToolDiameter: function () {
            var diameter = this.get('controller.tool.diameter');
            if (diameter != null)
                this.get('toolDrawing').animate({
                    r: diameter / 2
                }, 200);
        }.observes('controller.tool.diameter'),
        slotLengthWidthChanged: function () {
            var w = this.get('controller.slot.width');
            var l = this.get('controller.slot.length');
            if (w != null && l != null)
                this.get('slotDrawing').animate({x: 320 - w / 2, y: 240 - l / 2, width: w, height: l}, 200);
        }.observes('controller.slot.length', 'controller.slot.width'),
        operationIncrementChanged: function () {
            var l = this.get('controller.slot.length');
            var inc = this.get('controller.operation.increment');
            var operationPath = this.get('operationPath');
            if (l == null || inc == null || inc == 0) {
                operationPath.attr({'path': ''});
                return;
            }
            var trochoR = this.get('controller.operation.trochoidalRadius');
            var startX = 320;
            var startY = 240 + this.get('controller.operation.pathStartY');
            this.get('operationAxis').animate({path: 'M 320 ' + (startY - 10) + 'L 320 ' + (240 + l / 2 + 10) }, 200);
            var pathLength = this.get('controller.operation.pathGeneratorLength');
            var tInc = pathLength / inc;
            var segments = tInc * 15;
            segments = Math.min(segments, 2000);
            var path = '';
            var dirX = 0;
            var dirY = 1;
            var a = inc / (2 * Math.PI);
            for (var i = 0; i < segments; i++) {
                var ratio = (i / segments);
                var t = ratio * tInc * 2 * Math.PI - Math.PI / 2;
                var x = startX + dirX * t + trochoR * Math.cos(t);
                var y = startY + dirY * a * t + trochoR * Math.sin(t);
                if (i == 0)
                    path = 'M ' + x + ' ' + y + ' R ' + x + ' ' + y;
                else
                    path += ' ' + x + ' ' + y;
            }
            operationPath.attr({'path': path});
            console.log(operationPath.getTotalLength());
            console.log('trocho', this.get('controller.operation.actualPathLength'));
            var start = operationPath.getPointAtLength(0);
            this.get('toolDrawing').attr({cx: start.x, cy: start.y});
        }.observes('controller.operation.increment', 'controller.slot.length', 'controller.slot.width', 'controller.tool.diameter')
    });
    TestApp.Document.FIXTURES = [
        { id: 1, tool: 1, slot: 1, operation: 1}
    ];
    TestApp.Tool.FIXTURES = [
        { id: 1, document: 1, diameter: 30, flutes: 2}
    ];
    TestApp.Slot.FIXTURES = [
        { id: 1, document: 1, depth: 10, length: 300, width: 100}
    ];
    TestApp.Operation.FIXTURES = [
        { id: 1, document: 1, increment: 10, rotationFrequency: 1000, feedRate: 150}
    ];
</script>
</body>
</html>
