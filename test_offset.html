<!doctype html>
<html>
<head>
    <title>Contouring Test</title>
    <script src="webapp/libs/jquery.min.js"></script>
    <script src="webapp/libs/svg.js"></script>
    <script src="webapp/libs/svg.draggable.js"></script>
    <script src="webapp/libs/svg.memory.js"></script>
    <script src="webapp/libs/jquery.mousewheel.js"></script>
    <script src="webapp/libs/clipper_unminified.js"></script>
    <script src="webapp/cnc/cam.js"></script>

    <script src="samples/box.js"></script>
    <script src="samples/joystick_plate.js"></script>

    <style>
        * {
            -webkit-box-sizing: border-box;
            -moz-box-sizing: border-box;
            box-sizing: border-box;
        }
    </style>
</head>
<body>
<div id="drawing" style="border:solid; width:600px; height: 700px; float:left;overflow: hidden">
</div>
<textarea id='code' style="border:solid; width:600px; height: 700px; float:right;"></textarea>
<script>

</script>
<script>
    var drawing = $('#drawing');
    var svg = SVG(drawing[0]).size(600, 700);
    var paper = svg.group().attr({id: 'root', 'vector-effect': 'non-scaling-stroke'});
    function setMatrix(element, matrix) {
        var components = $.map('abcdef'.split(''),function (c) {
            return matrix[c];
        }).join(',');
        element.attr({transform: 'matrix(' + components + ')'});
    }
    drawing.mousewheel(function (event, delta) {
        var svgRoot = paper.node;
        var p = svg.node.createSVGPoint();
        p.x = event.clientX;
        p.y = event.clientY;
        p = p.matrixTransform(svgRoot.getCTM().inverse());
        var k = svg.node.createSVGMatrix().translate(p.x, p.y).scale(1 + delta / 360).translate(-p.x, -p.y);
        var m = svgRoot.getCTM().multiply(k);
        setMatrix(paper, m);
        event.preventDefault();
    });
    function zoomExtent(paper) {
        var box = paper.bbox();
        var m = paper.node.getCTM();
        var newScale = Math.min(svg.node.width.baseVal.value / box.width, svg.node.height.baseVal.value / box.height) * 0.9;
        m.a = newScale;
        m.d = -newScale;
        m.e = -box.x + box.width * 0.25;
        m.f = -(-box.y + box.height * 0.5 - svg.node.height.baseVal.value);
        setMatrix(paper, m);
    }
    var machine = new Machine(paper);
    createFixturePlate(machine);
    $('#code').text(machine.dumpGCode());
    zoomExtent(paper);
</script>
</body>
</html>
