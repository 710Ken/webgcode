<!DOCTYPE html >
<html>
<head>
    <meta http-equiv="X-UA-Compatible" content="chrome=1"/>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <title>g-code simulator</title>
    <script src="webapp/libs/x3dom.js"></script>
    <script src="webapp/libs/jquery.min.js"></script>
    <script src="webapp/libs/jquery.flot.min.js"></script>
    <script src="webapp/libs/jquery.flot.resize.js"></script>
    <script src="webapp/libs/jsparse.js"></script>
    <script src="webapp/cnc/geometry.js"></script>
    <script src="webapp/cnc/simulation.js"></script>
    <script src="webapp/cnc/parser.js"></script>
    <link rel="stylesheet" href="webapp/libs/x3dom.css">
    <style>
        X3D, x3d {
            float: right;
            width: 50%;
            height: 400px;
        }

        .editBlock {
            position: relative;
            float: left;
            width: 49%;
            height: 400px;
            padding: 1px;
            margin: 0;
            text-align: right;
        }

        .editBlock textarea {
            width: 100%;
            -webkit-box-sizing: border-box;
            -moz-box-sizing: border-box;
            box-sizing: border-box;
            height: 350px;
        }

        .chart {
            position: relative;
            clear: both;
            width: 100%;
            height: 200px;
        }
    </style>
</head>
<body>

<h1>G-Code Q'n'dirty toolpath simulator</h1>

<p>
    Paste your g-code in the left window and see the 3D preview of your toolpath on the right.<br>
    The right pane is interactive, drag it to change the point of view (<a
        href="http://x3dom.org/docs/dev/navigation.html#interactive-camera-movement">view documentation</a>).
</p>

<p>
    <a href="https://github.com/nraynaud/webgcode/tree/gh-pages">https://github.com/nraynaud/webgcode/tree/gh-pages</a>
</p>

<x3d id="x3d" xmlns="http://www.x3dom.org/x3dom" showStat="false" showLog="false" x="0px" y="0px">
    <Scene id="scene" DEF='scene'>
        <Shape id="xaxis">
            <Appearance>
                <Material emissiveColor='1 0 0'/>
            </Appearance>
            <IndexedLineSet id="lineSet" coordIndex="0 1 -1">
                <Coordinate id="coordinates" point="0.0 0.0 0.0, 10.0 0.0 0.0"/>
            </IndexedLineSet>
        </Shape>
        <transform translation='11 0 0'>
            <Shape>
                <Appearance>
                    <Material emissiveColor='1 0 0'/>
                </Appearance>
                <text string='X' style="BOLD"></text>
            </Shape>
        </transform>
        <Shape id="yaxis">
            <Appearance>
                <Material emissiveColor='0 1 0'/>
            </Appearance>
            <IndexedLineSet id="lineSet" coordIndex="0 1 -1">
                <Coordinate id="coordinates" point="0.0 0.0 0.0, 0.0 10.0 0.0"/>
            </IndexedLineSet>
        </Shape>
        <transform translation='0 11 0'>
            <Shape>
                <Appearance>
                    <Material emissiveColor='0 1 0'/>
                </Appearance>
                <text string='Y' style="BOLD"></text>
            </Shape>
        </transform>
        <Shape id="zaxis">
            <Appearance>
                <Material emissiveColor='0 0 1'/>
            </Appearance>
            <IndexedLineSet id="lineSet" coordIndex="0 1 -1">
                <Coordinate id="coordinates" point="0.0 0.0 0.0, 0.0 0.0 10.0"/>
            </IndexedLineSet>
        </Shape>
        <transform translation='0 0 11'>
            <Shape>
                <Appearance>
                    <Material emissiveColor='0 0 1'/>
                </Appearance>
                <text string='Z' style="BOLD"></text>
            </Shape>
        </transform>
    </Scene>
</x3d>
<div class="editBlock">
    <textarea id="codebox">
        %
        (Generated by gcode_tools from inkscape.)
        M3
        G21 (All units in mm)#4 = 4.000000 (Feed)
        #5 = 1.000000 (Scale xy)
        #7 = 1.000000 (Scale z)
        #8 = 0.000000 (Offset x)
        #9 = 0.000000 (Offset y)
        #10 = 0.000000 (Offset z)
        #11 = 5.000000 (Safe distanse)
        G00 Z[5.000000*#7+#10]
        G00 X[151.428570*#5+#8] Y[-609.505040*#5+#9]
        G01 Z[-1.000000*#7+#10]F#4
        G01 X[151.428570*#5+#8] Y[-552.362180*#5+#9] Z[-1.000000*#7+#10]F#4
        G01 X[151.428570*#5+#8] Y[-469.505040*#5+#9] Z[-1.000000*#7+#10]
        G01 X[151.428570*#5+#8] Y[-458.076470*#5+#9] Z[-1.000000*#7+#10]
        G03 X[151.033722*#5+#8] Y[-456.403864*#5+#9] Z[-1.000000*#7+#10] I[-3.740067*#5] J[0.000000*#5]
        G02 X[151.428570*#5+#8] Y[-455.219330*#5+#9] Z[-1.000000*#7+#10] I[0.789689*#5] J[0.394844*#5]
        G02 X[154.207243*#5+#8] Y[-454.886908*#5+#9] Z[-1.000000*#7+#10] I[1.852448*#5] J[-3.704874*#5]
        G03 X[157.142860*#5+#8] Y[-455.219330*#5+#9] Z[-1.000000*#7+#10] I[2.935617*#5] J[12.795985*#5]
        G01 X[165.714290*#5+#8] Y[-455.219330*#5+#9] Z[-1.000000*#7+#10]
        G02 X[168.585403*#5+#8] Y[-455.360436*#5+#9] Z[-1.000000*#7+#10] I[-0.000000*#5] J[-29.280040*#5]
        G03 X[171.428570*#5+#8] Y[-455.219330*#5+#9] Z[-1.000000*#7+#10] I[0.947722*#5] J[9.618431*#5]
        G03 X[175.697700*#5+#8] Y[-453.679920*#5+#9] Z[-1.000000*#7+#10] I[-3.004135*#5] J[15.020470*#5]
        G02 X[180.000000*#5+#8] Y[-452.362180*#5+#9] Z[-1.000000*#7+#10] I[5.442949*#5] J[-10.088553*#5]
        G02 X[189.987566*#5+#8] Y[-452.112956*#5+#9] Z[-1.000000*#7+#10] I[6.658378*#5] J[-66.583583*#5]
        G03 X[200.000000*#5+#8] Y[-452.362180*#5+#9] Z[-1.000000*#7+#10] I[10.012434*#5] J[200.997665*#5]
        G01 X[225.714290*#5+#8] Y[-452.362180*#5+#9] Z[-1.000000*#7+#10]
        G01 X[254.285710*#5+#8] Y[-452.362180*#5+#9] Z[-1.000000*#7+#10]
        G02 X[255.831231*#5+#8] Y[-452.644509*#5+#9] Z[-1.000000*#7+#10] I[0.000000*#5] J[-4.371398*#5]
        G03 X[257.142860*#5+#8] Y[-452.362180*#5+#9] Z[-1.000000*#7+#10] I[0.437209*#5] J[1.156749*#5]
        G03 X[257.142857*#5+#8] Y[-450.933613*#5+#9] Z[-1.000000*#7+#10] I[-0.714282*#5] J[0.714282*#5]
        G02 X[257.142860*#5+#8] Y[-449.505040*#5+#9] Z[-1.000000*#7+#10] I[0.714280*#5] J[0.714285*#5]
        G02 X[258.571425*#5+#8] Y[-449.505035*#5+#9] Z[-1.000000*#7+#10] I[0.714285*#5] J[-0.714274*#5]
        G03 X[260.000000*#5+#8] Y[-449.505040*#5+#9] Z[-1.000000*#7+#10] I[0.714290*#5] J[0.714290*#5]
        G03 X[262.639921*#5+#8] Y[-443.762236*#5+#9] Z[-1.000000*#7+#10] I[-6.437397*#5] J[6.437397*#5]
        G03 X[262.857140*#5+#8] Y[-438.076470*#5+#9] Z[-1.000000*#7+#10] I[-74.304629*#5] J[5.685766*#5]
        G02 X[262.981676*#5+#8] Y[-430.163006*#5+#9] Z[-1.000000*#7+#10] I[251.486422*#5] J[-0.000000*#5]
        G03 X[263.040807*#5+#8] Y[-417.157041*#5+#9] Z[-1.000000*#7+#10] I[-241.429415*#5] J[7.600766*#5]
        G03 X[262.144440*#5+#8] Y[-404.358781*#5+#9] Z[-1.000000*#7+#10] I[-134.937888*#5] J[-3.020293*#5]
        G03 X[260.000000*#5+#8] Y[-398.076470*#5+#9] Z[-1.000000*#7+#10] I[-15.703670*#5] J[-1.853227*#5]
        G03 X[253.415897*#5+#8] Y[-391.895175*#5+#9] Z[-1.000000*#7+#10] I[-14.182491*#5] J[-8.509473*#5]
        G02 X[245.714290*#5+#8] Y[-386.647900*#5+#9] Z[-1.000000*#7+#10] I[17.771329*#5] J[34.359193*#5]
        G02 X[241.359618*#5+#8] Y[-382.435888*#5+#9] Z[-1.000000*#7+#10] I[39.977704*#5] J[45.688826*#5]
        G03 X[237.142860*#5+#8] Y[-378.076470*#5+#9] Z[-1.000000*#7+#10] I[-133.144422*#5] J[-124.568246*#5]
        G03 X[231.355754*#5+#8] Y[-373.881527*#5+#9] Z[-1.000000*#7+#10] I[-131.783168*#5] J[-175.711352*#5]
        G02 X[225.714290*#5+#8] Y[-369.505040*#5+#9] Z[-1.000000*#7+#10] I[41.951671*#5] J[59.901631*#5]
        G02 X[221.540019*#5+#8] Y[-365.072218*#5+#9] Z[-1.000000*#7+#10] I[18.586254*#5] J[21.683998*#5]
        G03 X[217.142860*#5+#8] Y[-360.933610*#5+#9] Z[-1.000000*#7+#10] I[-14.465689*#5] J[-10.964165*#5]
        G03 X[212.967792*#5+#8] Y[-359.294696*#5+#9] Z[-1.000000*#7+#10] I[-5.859269*#5] J[-8.788886*#5]
        G02 X[208.571430*#5+#8] Y[-358.076470*#5+#9] Z[-1.000000*#7+#10] I[3.307354*#5] J[20.477620*#5]
        G02 X[202.755063*#5+#8] Y[-355.487262*#5+#9] Z[-1.000000*#7+#10] I[30.864380*#5] J[77.160909*#5]
        G01 X[202.683408*#5+#8] Y[-355.274830*#5+#9] Z[-1.000000*#7+#10]
        G02 X[203.055026*#5+#8] Y[-355.089054*#5+#9] Z[-1.000000*#7+#10] I[0.309477*#5] J[-0.154491*#5]
        G03 X[205.606715*#5+#8] Y[-355.462010*#5+#9] Z[-1.000000*#7+#10] I[6.526307*#5] J[35.736116*#5]
        G03 X[206.419664*#5+#8] Y[-355.317050*#5+#9] Z[-1.000000*#7+#10] I[0.160078*#5] J[1.454295*#5]
        G03 X[206.440950*#5+#8] Y[-354.813562*#5+#9] Z[-1.000000*#7+#10] I[-0.128459*#5] J[0.257625*#5]
        G03 X[204.587182*#5+#8] Y[-353.843953*#5+#9] Z[-1.000000*#7+#10] I[-8.359138*#5] J[-13.724705*#5]
        G03 X[194.285710*#5+#8] Y[-349.505040*#5+#9] Z[-1.000000*#7+#10] I[-124.760428*#5] J[-281.808573*#5]
        G03 X[191.350601*#5+#8] Y[-349.653273*#5+#9] Z[-1.000000*#7+#10] I[-1.306360*#5] J[-3.265890*#5]
        G02 X[188.571430*#5+#8] Y[-349.505040*#5+#9] Z[-1.000000*#7+#10] I[-1.264446*#5] J[2.420328*#5]
        G02 X[187.033343*#5+#8] Y[-346.781479*#5+#9] Z[-1.000000*#7+#10] I[1.920383*#5] J[2.880590*#5]
        G03 X[185.714290*#5+#8] Y[-343.790750*#5+#9] Z[-1.000000*#7+#10] I[-4.514794*#5] J[-0.204991*#5]
        G03 X[184.531982*#5+#8] Y[-343.376852*#5+#9] Z[-1.000000*#7+#10] I[-1.021047*#5] J[-1.021047*#5]
        G02 X[177.142860*#5+#8] Y[-343.790750*#5+#9] Z[-1.000000*#7+#10] I[-7.389122*#5] J[65.750196*#5]
        G03 X[174.831385*#5+#8] Y[-344.336419*#5+#9] Z[-1.000000*#7+#10] I[0.000000*#5] J[-5.168586*#5]
        G02 X[174.285710*#5+#8] Y[-343.790750*#5+#9] Z[-1.000000*#7+#10] I[-0.181892*#5] J[0.363781*#5]
        G02 X[181.160926*#5+#8] Y[-338.699312*#5+#9] Z[-1.000000*#7+#10] I[8.452651*#5] J[-4.226337*#5]
        G02 X[188.571430*#5+#8] Y[-338.076470*#5+#9] Z[-1.000000*#7+#10] I[7.410504*#5] J[-43.773240*#5]
        G02 X[193.048899*#5+#8] Y[-338.709807*#5+#9] Z[-1.000000*#7+#10] I[-0.000000*#5] J[-16.143724*#5]
        G03 X[197.142860*#5+#8] Y[-338.076470*#5+#9] Z[-1.000000*#7+#10] I[1.364655*#5] J[4.727297*#5]
        G03 X[197.847573*#5+#8] Y[-335.596480*#5+#9] Z[-1.000000*#7+#10] I[-1.102222*#5] J[1.653328*#5]
        G02 X[197.142860*#5+#8] Y[-332.362180*#5+#9] Z[-1.000000*#7+#10] I[7.069594*#5] J[3.234300*#5]
        G01 X[197.142860*#5+#8] Y[-320.933610*#5+#9] Z[-1.000000*#7+#10]
        G02 X[198.014696*#5+#8] Y[-305.386581*#5+#9] Z[-1.000000*#7+#10] I[139.057307*#5] J[-0.000000*#5]
        G03 X[200.000000*#5+#8] Y[-283.790750*#5+#9] Z[-1.000000*#7+#10] I[-529.154378*#5] J[59.534324*#5]
        G03 X[200.152819*#5+#8] Y[-275.224774*#5+#9] Z[-1.000000*#7+#10] I[-79.948259*#5] J[5.710650*#5]
        G02 X[200.000000*#5+#8] Y[-266.647900*#5+#9] Z[-1.000000*#7+#10] I[240.608955*#5] J[8.576874*#5]
        G01 X[200.000000*#5+#8] Y[-240.933610*#5+#9] Z[-1.000000*#7+#10]
        G01 X[200.000000*#5+#8] Y[-226.647900*#5+#9] Z[-1.000000*#7+#10]
        G02 X[200.282329*#5+#8] Y[-225.102386*#5+#9] Z[-1.000000*#7+#10] I[4.371354*#5] J[-0.000000*#5]
        G03 X[200.000000*#5+#8] Y[-223.790750*#5+#9] Z[-1.000000*#7+#10] I[-1.156752*#5] J[0.437213*#5]
        G03 X[194.534167*#5+#8] Y[-219.279759*#5+#9] Z[-1.000000*#7+#10] I[-26.299833*#5] J[-26.299833*#5]
        G03 X[194.171663*#5+#8] Y[-219.500116*#5+#9] Z[-1.000000*#7+#10] I[-0.130717*#5] J[-0.193313*#5]
        G02 X[193.936364*#5+#8] Y[-220.354774*#5+#9] Z[-1.000000*#7+#10] I[-1.172787*#5] J[-0.136836*#5]
        G02 X[191.428570*#5+#8] Y[-220.933610*#5+#9] Z[-1.000000*#7+#10] I[-1.604214*#5] J[1.228326*#5]
        G02 X[189.903543*#5+#8] Y[-219.638862*#5+#9] Z[-1.000000*#7+#10] I[1.879849*#5] J[3.759699*#5]
        G03 X[188.571430*#5+#8] Y[-218.076470*#5+#9] Z[-1.000000*#7+#10] I[-10.485324*#5] J[-7.590820*#5]
        G00 Z[5.000000*#7+#10]
        M5
        G00 X0.0000 Y0.0000
        M2
        (end)
        %
    </textarea>
    <button onclick="evaluateCode();">Simulate</button>
</div>
<div class="chart" id="chart1"></div>
<div class="chart" id="chart2"></div>
<div class="chart" id="chart3"></div>
<script>
    function getURLParameter(name) {
        return decodeURIComponent((new RegExp('[?|&]' + name + '=' + '([^&;]+?)(&|#|;|$)').exec(location.search) || [, ""])[1].replace(/\+/g, '%20')) || null;
    }
    x3dom.runtime.ready = (function () {
        var code = getURLParameter('code');
        if (code !== null)
            $('#codebox').val(code);
        evaluateCode();
        $('#x3d')[0].runtime.showAll();
        window.addEventListener("message", function (event) {
            console.log(event);
            if (event.data['type'] == 'gimme program') {
                evaluateCode();
                event.source.postMessage({type: 'program', program: $('#codebox').val()}, event.origin);
            }
        }, false);
    });
</script>

</body>
</html>

