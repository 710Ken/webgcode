<!DOCTYPE html >
<html>
<head>
    <meta http-equiv="X-UA-Compatible" content="chrome=1"/>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <title>g-code simulator</title>
    <script src="webapp/libs/jquery.min.js"></script>
    <script src="webapp/libs/Three.min.js"></script>
    <script src="webapp/libs/TrackballControls.js"></script>
    <script src="webapp/libs/OrbitControls.js"></script>
    <script src="webapp/libs/ace/src-noconflict/ace.js"></script>
    <script src="webapp/libs/require.js"></script>
    <script src="webapp/libs/handlebars-v1.3.0.js"></script>
    <script src="webapp/libs/ember-1.5.0-beta5.pre7.js"></script>

    <script>
        requirejs.config({
            baseUrl: 'webapp',
            paths: {
                text: 'libs/require_text'
            }
        });
    </script>

    <style>
        body {
            margin-top: 0;
        }

        h1 {
            margin-top: 0;
        }

        .editBlock {
            position: relative;
            float: left;
            width: 39%;
            height: 400px;
            padding: 1px;
            margin: 0;
        }

        .editBlock pre {
            width: 100%;
            -webkit-box-sizing: border-box;
            -moz-box-sizing: border-box;
            box-sizing: border-box;
            height: 350px;
            margin: 0;
        }

        .viewContainer {
            float: right;
            width: 60%;
        }

        #loader {
            display: inline-block;
            background-size: 100% 100%;
            background-image: url(webapp/spinner.svg);
            width: 20px;
            height: 20px;
        }

        .boundsTable {
            border-collapse: collapse;
        }

        .boundsTable td {
            border: dashed gray 1px;
            padding: 3px;
        }

        .ThreeDView {
            background: #000;
            height: 400px;
        }
    </style>
</head>
<body>

<h1>G-Code Q'n'dirty toolpath simulator</h1>

<p>
    Paste your g-code in the left window and see the 3D preview of your toolpath on the right.<br>
    The right pane is interactive, drag it to change the point of view.
</p>

<p>
    <a href="https://github.com/nraynaud/webgcode/tree/gh-pages">https://github.com/nraynaud/webgcode/tree/gh-pages</a>
</p>

<div id="app">

</div>
<script>
    require(['cnc/threeDView', 'cnc/util', 'cnc/ui/gcodeEditor', 'text!templates/gcodeSimulator.hbs'],
            function (threeD, util, gcodeEditor, applicationTemplate) {
                var demoCode = 'G0 Y10 Z-5\n' +
                        'G1 Z-10\n' +
                        'G1 Y20\n' +
                        'G02 X10 Y30 R10\n' +
                        'G1 X30\n' +
                        'G2 X40 Y20 R10\n' +
                        'G1 Y10\n' +
                        'G2 X30 Y0 R10\n' +
                        'G1 X10\n' +
                        'G2 X0 Y10 Z-15 R10 (yeah spiral !)\n' +
                        'G3 X-10 Y20 R-10 (yeah, long arc !)\n' +
                        'G3 X0 Y10 I10 (center)\n' +
                        'G91 G1 X10 Z10\n' +
                        'G3 Y10 R5 Z3 (circle in incremental)\n' +
                        'Y10 R5 Z3 (again, testing modal state)\n' +
                        'G20 G0 X1 (one inch to the right)\n' +
                        'G3 X-1 R1 (radius in inches)\n' +
                        'G3 X1 Z0.3 I0.5 J0.5 (I,J in inches)\n' +
                        'G21 (back to mm)\n' +
                        'G80 X10 (do nothing)\n' +
                        'G90\n' +
                        'G0 X30 Y30 Z30\n' +
                        'G18 (X-Z plane)\n' +
                        'G3 Z40 I0 K5\n' +
                        'G19 (Y-Z plane)\n' +
                        'G3 Z50 J0 K5\n' +
                        'G17 (back to X-Y plane)\n';

                function parseInWorker(code, resultHandler) {
                    var worker = new Worker('webapp/worker.js');
                    window.myWorker = worker;
                    worker.onmessage = function (event) {
                        resultHandler(event.data);
                        window.myWorker = null;
                    };
                    worker.postMessage({
                        operation: 'simulateGCode',
                        code: code
                    });
                }

                function parseImmediately(code, resultHandler) {
                    require(['cnc/gcodeSimulation'], function (gcodeSimulation) {
                        resultHandler(gcodeSimulation.simulateGCode(code));
                    });
                }

                Ember.Handlebars.helper('num', function (value) {
                    return new Handlebars.SafeString(Handlebars.Utils.escapeExpression(util.formatCoord(value)));
                });
                Ember.TEMPLATES['application'] = Ember.Handlebars.compile(applicationTemplate);

                window.Simulator = Ember.Application.create({
                    rootElement: '#app'
                });

                Simulator.GcodeEditorComponent = gcodeEditor.GcodeEditorComponent;

                Simulator.ThreeDView = Ember.View.extend({
                    classNames: ['ThreeDView'],
                    didInsertElement: function () {
                        var threeDView = new threeD.ThreeDView(this.$());
                        this.set('nativeComponent', threeDView);
                        this.simulatedPathChanged();
                        this.highlightChanged();
                    },
                    simulatedPathChanged: function () {
                        var path = this.get('controller.simulatedPath');
                        if (path != null)
                            this.get('nativeComponent').displayPath(path);
                        else
                            this.get('nativeComponent').clearToolpath();
                    }.observes('controller.simulatedPath'),
                    highlightChanged: function () {
                        var highlight = this.get('controller.currentHighLight');
                        if (highlight)
                            this.get('nativeComponent').displayHighlight(highlight);
                        else
                            this.get('nativeComponent').hideHighlight();
                    }.observes('controller.currentHighLight')
                });

                Simulator.ApplicationController = Ember.ObjectController.extend({
                    init: function () {
                        this._super();
                        this.launchSimulation();
                    },
                    actions: {
                        simulate: function () {
                            this.launchSimulation();
                        }
                    },
                    launchSimulation: function () {
                        var _this = this;

                        function handleResult(result) {
                            _this.set('simulatedPath', result.simulatedPath);
                            console.timeEnd('simulation');
                            var errors = [];
                            for (var i = 0; i < result.errors.length; i++) {
                                var error = result.errors[i];
                                errors.push({row: error.lineNo, text: error.message, type: "error"});
                            }
                            _this.set('errors', errors);
                            _this.set('bbox', {min: result.min, max: result.max});
                            _this.set('totalTime', result.totalTime);
                            _this.set('lineSegmentMap', result.lineSegmentMap);
                            $('#loader').hide();
                            $('#simulateButton').prop('disabled', false);
                        }

                        this.set('simulatedPath', null);
                        $('#loader').show();
                        $('#simulateButton').prop('disabled', true);
                        var code = this.get('code');
                        try {
                            parseInWorker(code, handleResult);
                        } catch (error) {
                            console.log('worker error', error);
                            console.log('trying again without worker');
                            parseImmediately(code, handleResult)
                        }
                    },
                    currentHighLight: function () {
                        return this.get('lineSegmentMap')[this.get('currentRow')];
                    }.property('currentRow').readOnly(),
                    code: demoCode,
                    errors: [],
                    bbox: {},
                    totalTime: 0,
                    lineSegmentMap: [],
                    currentRow: null,
                    simulatedPath: null
                });
            });
</script>
</body>
</html>

