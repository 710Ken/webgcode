<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>webgecode test</title>
    <link rel="stylesheet" href="assets/qunit.css">
    <style>        .chart {
        position: relative;
        clear: both;
        width: 100%;
        height: 200px;
    }
    </style>
</head>
<body>
<div id="qunit"></div>
<div id="qunit-fixture"></div>
<h1>Testing random speed planning</h1>

<div class="chart" id="chart1"></div>
<script src="assets/qunit.js"></script>
<script src="assets/jquery.min.js"></script>
<script src="assets/jquery.flot.min.js"></script>
<script src="simulation.js"></script>
<script src="parser.js"></script>
<script src="tests.js"></script>
<script>
    function limitSpeed(speedSegments, acceleration) {
        for (var i = 0; i < speedSegments.length; i++) {
            var segment = speedSegments[i];
            var speed = segment.speed;
            var previousSpeed = 0;
            var nextSpeed = 0;
            if (i > 0)
                previousSpeed = speedSegments[i - 1].speed;
            if (i < speedSegments.length - 1)
                nextSpeed = speedSegments[i + 1].speed;
            var accelerationLength = previousSpeed * previousSpeed / (2 * acceleration);
            var maxSpeed = Math.sqrt(2 * acceleration * (accelerationLength + segment.length));
            segment.speed = Math.min(speed, maxSpeed);
        }
    }

    function planSpeed(speedSegments, acceleration) {
        limitSpeed(data, acceleration);
        data.reverse();
        limitSpeed(data, acceleration);
        data.reverse();
        for (var i = 0; i < data.length; i++) {
            var nextSpeed = (i < data.length - 1 ? data[i + 1].speed : 0);
            var previousSpeed = (i >= 1 ? data[i - 1].speed : 0);
            var segmentLength = 0;
            if (nextSpeed < data[i].speed || previousSpeed < data[i].speed) {
                var accelerationLength = previousSpeed * previousSpeed / (2 * acceleration);
                var deccelerationLength = nextSpeed * nextSpeed / (2 * acceleration);

                function accelerate(x) {
                    return Math.sqrt(2 * acceleration * (accelerationLength + x));
                }

                function deccelerate(x) {
                    return Math.sqrt(2 * acceleration * (deccelerationLength + data[i].length - x));
                }
                var meetingPoint = (deccelerationLength + data[i].length - accelerationLength) / 2;
                var maxAccelerationPoint = (Math.pow(data[i].speed, 2) - 2 * acceleration * accelerationLength) / (2 * acceleration);
                var maxDeccelerationPoint = (2 * acceleration * (deccelerationLength + data[i].length) - Math.pow(data[i].speed, 2)) / (2 * acceleration);
                if (meetingPoint >= 0 && meetingPoint <= data[i].length && accelerate(meetingPoint) < data[i].speed) {
                    data[i].stopAccelerationPoint = meetingPoint;
                    data[i].stopDeccelerationPoint = meetingPoint;
                } else {
                    if (maxAccelerationPoint >= 0 && maxAccelerationPoint < data[i].length)
                        data[i].stopAccelerationPoint = maxAccelerationPoint;
                    if (maxDeccelerationPoint >= 0 && maxDeccelerationPoint < data[i].length)
                        data[i].stopDeccelerationPoint = maxDeccelerationPoint;
                }
            }
        }
    }

    var rawData = [
        [2, 2],
        [3, 1],
        [5, 2],
        [4, 2],
        [2, 4],
        [4, 1],
        [5, 1],
        [6, 2],
        [5, 2],
        [6, 2],
        [5, 1],
        [6, 1],
        [4, 3],
        [6, 3],
        [5, 2]
    ];
    //rawData= [[1,2]];
    rawData = [];
    for (i = 0; i < 20; i++)
        rawData.push([Math.random() * 10, Math.random() * 10]);
    var acceleration = 7;
    data = [];
    var i = 0;
    var plotData = [
        {label: 'reference(mm->mm/s)', shadowSize: 0, color: 'red', data: []},
        {label: 'actual(mm->mm/s)', shadowSize: 0, color: 'blue', data: []},
        {points: {show: true, radius: 4, fill: false, symbol: "circle"}, color: 'green', lines: {show: false}, data: []},
        {points: {show: true, radius: 4, fill: false, symbol: "circle"}, color: 'yellow', lines: {show: false}, data: []},
        {points: {show: true, radius: 4, fill: false, symbol: "circle"}, color: 'orange', lines: {show: false}, data: []}
    ];
    var l = 0;

    for (i = 0; i < rawData.length; i++)
        data.push({length: rawData[i][1], speed: rawData[i][0]});
    for (i = 0; i < data.length; i++) {
        plotData[0].data.push([l, data[i].speed]);
        l += data[i].length;
        plotData[0].data.push([l, data[i].speed]);
    }
    planSpeed(data, acceleration);
    var steps = 100;
    l = 0;
    for (i = 0; i < data.length; i++) {
        var nextSpeed = (i < data.length - 1 ? data[i + 1].speed : 0);
        var previousSpeed = (i >= 1 ? data[i - 1].speed : 0);
        var segmentLength = 0;
        if (nextSpeed < data[i].speed || previousSpeed < data[i].speed) {
            var accelerationLength = previousSpeed * previousSpeed / (2 * acceleration);
            var deccelerationLength = nextSpeed * nextSpeed / (2 * acceleration);

            function accelerate(x) {
                return Math.sqrt(2 * acceleration * (accelerationLength + x));
            }

            function deccelerate(x) {
                return Math.sqrt(2 * acceleration * (deccelerationLength + data[i].length - x));
            }

            if (data[i].stopAccelerationPoint && data[i].stopAccelerationPoint == data[i].stopDeccelerationPoint)
                plotData[2].data.push([l + data[i].stopAccelerationPoint, accelerate(data[i].stopAccelerationPoint)]);
            else {
                if (data[i].stopAccelerationPoint)
                    plotData[3].data.push([l + data[i].stopAccelerationPoint, accelerate(data[i].stopAccelerationPoint)]);
                if (data[i].stopDeccelerationPoint)
                    plotData[4].data.push([l + data[i].stopDeccelerationPoint, deccelerate(data[i].stopDeccelerationPoint)]);
            }

            for (var j = 0; j <= steps; j++) {
                segmentLength = data[i].length * j / steps;
                var speeds = [data[i].speed];
                if (nextSpeed < data[i].speed)
                    speeds.push(deccelerate(segmentLength));
                if (previousSpeed < data[i].speed)
                    speeds.push(accelerate(segmentLength));
                plotData[1].data.push([l + segmentLength, Math.min.apply(null, speeds)]);
            }
        } else {
            segmentLength = data[i].length;
            plotData[1].data.push([l + segmentLength, data[i].speed]);
        }
        l += data[i].length;
    }
    var chart1 = $.plot("#chart1", plotData);
</script>
</body>
</html>